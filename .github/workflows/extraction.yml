name: Stablecoin Extraction (Manual)

on:
  workflow_dispatch:

concurrency:
  group: stablecoin-extraction
  cancel-in-progress: false

jobs:
  extract:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          echo "Current directory:" && pwd
          echo "Root contents:" && ls -al
          python -m pip install --upgrade pip
          if [ -f "stablecoin-analytics-platform/requirements.txt" ]; then
            echo "Installing deps from stablecoin-analytics-platform/requirements.txt"
            pip install -r stablecoin-analytics-platform/requirements.txt
          elif [ -f "requirements.txt" ]; then
            echo "Installing deps from requirements.txt at repo root"
            pip install -r requirements.txt
          else
            echo "requirements.txt not found in expected locations" && exit 1
          fi

      - name: Mask secrets in logs
        run: |
          if [ -n "${{ secrets.NEON_DB_URL }}" ]; then echo "::add-mask::${{ secrets.NEON_DB_URL }}"; fi
          if [ -n "${{ secrets.ALCHEMY_ETH_URL }}" ]; then echo "::add-mask::${{ secrets.ALCHEMY_ETH_URL }}"; fi
          if [ -n "${{ secrets.ALCHEMY_SOL_URL }}" ]; then echo "::add-mask::${{ secrets.ALCHEMY_SOL_URL }}"; fi

      - name: Preflight – verify required secrets are set
        env:
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
          DATABASE_URL: ${{ secrets.NEON_DB_URL }}
          ALCHEMY_ETH_URL: ${{ secrets.ALCHEMY_ETH_URL }}
          ALCHEMY_SOL_URL: ${{ secrets.ALCHEMY_SOL_URL }}
        run: |
          echo "Validating required secrets: NEON_DB_URL ALCHEMY_ETH_URL ALCHEMY_SOL_URL"
          echo "Presence check — NEON_DB_URL: ${NEON_DB_URL:+yes}" || true
          echo "Presence check — DATABASE_URL: ${DATABASE_URL:+yes}" || true
          missing=()
          for var in NEON_DB_URL ALCHEMY_ETH_URL ALCHEMY_SOL_URL; do
            if [ -z "${!var}" ]; then
              missing+=("$var")
            fi
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing required secrets/envs: ${missing[*]}"
            exit 1
          else
            echo "All required secrets present."
          fi

      - name: Run extraction
        env:
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
          DATABASE_URL: ${{ secrets.NEON_DB_URL }}
          ALCHEMY_ETH_URL: ${{ secrets.ALCHEMY_ETH_URL }}
          ALCHEMY_SOL_URL: ${{ secrets.ALCHEMY_SOL_URL }}
          PYTHONUNBUFFERED: '1'
        run: |
          if [ -f "stablecoin-analytics-platform/main.py" ]; then
            echo "Running stablecoin-analytics-platform/main.py"
            python3 stablecoin-analytics-platform/main.py
          elif [ -f "main.py" ]; then
            echo "Running main.py at repo root"
            python3 main.py
          else
            echo "main.py not found in expected locations" && exit 1
          fi

      - name: Run transfers extraction (categorized_transfers)
        env:
          NEON_DB_URL: ${{ secrets.NEON_DB_URL }}
          DATABASE_URL: ${{ secrets.NEON_DB_URL }}
          ALCHEMY_ETH_URL: ${{ secrets.ALCHEMY_ETH_URL }}
          ALCHEMY_SOL_URL: ${{ secrets.ALCHEMY_SOL_URL }}
          PYTHONUNBUFFERED: '1'
        run: |
          if [ -f "stablecoin-analytics-platform/extractor/transfers.py" ]; then
            echo "Running stablecoin-analytics-platform/extractor/transfers.py"
            python3 stablecoin-analytics-platform/extractor/transfers.py
          elif [ -f "extractor/transfers.py" ]; then
            echo "Running extractor/transfers.py at repo root"
            python3 extractor/transfers.py
          else
            echo "extractor/transfers.py not found in expected locations" && exit 1
          fi